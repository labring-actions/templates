# 在 Sealos 上部署 n8n 工作流自动化平台

n8n 是一款强大的工作流自动化平台，兼具代码的灵活性与低代码的便捷性，让技术团队轻松构建复杂的自动化流程。本模板支持一键部署生产级 n8n 实例，可选配 PostgreSQL 数据库和 Redis 队列模式，助你在 Sealos Cloud 上快速搭建强大的自动化工作流。

## 关于 n8n

n8n 是一个基于 Node.js 的应用，提供可视化工作流编辑器和执行引擎，能够对接数百种服务和 API，实现任务自动化。无论是简单的自动化操作，还是包含条件逻辑、循环和数据转换的复杂多步骤工作流，n8n 都能胜任。

Sealos 模板提供灵活的部署选项：可以先用轻量级的 SQLite 方案进行测试，再升级到 PostgreSQL 以获得更好的性能和数据持久化，或启用 Redis 队列模式实现更高的可扩展性和并行执行能力。部署过程包含自动初始化、工作流数据持久存储，以及带 SSL 证书的安全公网访问。

## 典型应用场景

- **API 集成与数据同步**：连接不同服务，自动同步平台间的数据
- **业务流程自动化**：将数据录入、报表生成、通知发送等重复性工作交给机器
- **数据处理管道**：构建 ETL 工作流，在系统间进行数据的提取、转换和加载
- **Webhook 处理**：接收外部服务的 Webhook 请求，执行自定义逻辑
- **定时任务**：通过 Cron 表达式按计划运行工作流
- **客户沟通**：自动化邮件营销、通知推送和客服流程
- **DevOps 自动化**：集成 CI/CD 流水线、监控告警和部署工作流
- **内容管理**：自动化内容发布、社交媒体推送和内容聚合

## 依赖组件

Sealos 模板已包含所有必需组件：n8n 应用服务器，以及可选的 PostgreSQL 数据库和 Redis 队列服务。

### 相关文档

- [n8n 官方文档](https://docs.n8n.io/) - n8n 使用指南
- [n8n 快速入门](https://docs.n8n.io/try-it-out/) - 新手上路
- [n8n 工作流示例](https://n8n.io/workflows) - 社区工作流模板
- [n8n 节点参考](https://docs.n8n.io/integrations/) - 可用集成和节点
- [PostgreSQL 文档](https://www.postgresql.org/docs/) - 数据库后端文档
- [Redis 文档](https://redis.io/docs/) - 队列后端文档

## 技术架构

### 架构组件

本模板支持三种部署模式：

**1. 基础模式（默认）：**
- **n8n 应用**：使用 SQLite 数据库的工作流自动化服务器
  - 版本：n8n 1.123.9
  - Web 界面：端口 5678（通过 Ingress 暴露，带 SSL）
  - 持久存储：1Gi，用于工作流数据和 SQLite 数据库
  - 适用场景：测试、开发和轻量级生产环境

**2. PostgreSQL 模式：**
- **PostgreSQL 数据库**：为工作流和执行记录提供持久化存储
  - 版本：PostgreSQL 14.8.0
  - 持久存储：1Gi
  - 自动初始化 'n8n' 数据库
  - 通过 Kubernetes Secrets 管理连接凭据
- **n8n 应用**：连接 PostgreSQL，性能更佳
  - 适用场景：对可靠性要求较高的生产环境

**3. 队列模式（需启用 PostgreSQL）：**
- **PostgreSQL 数据库**：与 PostgreSQL 模式相同
- **Redis**：工作流执行的消息队列
  - 版本：Redis 7.0.6
  - 持久存储：1Gi
  - 包含 Redis Sentinel 实现高可用
- **n8n 主进程**：工作流编辑器和 API 服务器
- **n8n Worker**：专用的工作流执行进程
  - 支持工作流并行执行
  - 可扩展以应对高并发场景
  - 适用场景：高流量生产环境，需处理大量并发工作流

**资源配置：**

| 组件 | CPU 请求 | CPU 限制 | 内存请求 | 内存限制 |
|------|----------|----------|----------|----------|
| n8n（基础/PostgreSQL 模式） | 50m | 500m | 51Mi | 512Mi |
| n8n Worker（队列模式） | 20m | 200m | 25Mi | 256Mi |
| PostgreSQL | 50m | 500m | 51Mi | 512Mi |
| Redis | 50m | 500m | 51Mi | 512Mi |
| Redis Sentinel | 100m | 100m | 100Mi | 100Mi |

### 环境配置

模板会自动为 n8n 配置以下设置：

**基础配置：**
- 端口：5678
- Webhook URL：自动配置（基于部署域名）
- 时区：可配置（默认：America/New_York）
- 加密密钥：自动生成 32 位随机字符串

**数据库配置（启用 PostgreSQL 时）：**
- 客户端：PostgreSQL
- 连接：通过 Kubernetes Secrets 自动配置
- 数据库名：`n8n`
- SSL：禁用（集群内部通信）

**队列配置（启用队列模式时）：**
- 执行模式：队列
- Redis 连接：通过 Kubernetes Secrets 自动配置
- Worker 并发数：10 个并发工作流执行
- 健康检查：主进程和 Worker 均已启用

**公网访问地址：**
- Web 界面：`https://<app-host>.<domain>/`
- Webhook 端点：`https://<app-host>.<domain>/webhook/`
- 生产 Webhook：`https://<app-host>.<domain>/webhook-test/`

### 部署流程

部署流程因模式而异：

**基础模式：**
1. **应用部署**：n8n 使用 SQLite 数据库启动
2. **持久存储**：工作流数据存储在持久卷中

**PostgreSQL 模式：**
1. **数据库初始化任务**：在 PostgreSQL 中创建 `n8n` 数据库
2. **应用部署**：n8n 连接 PostgreSQL 并初始化表结构

**队列模式：**
1. **Redis 部署**：部署带 Sentinel 的 Redis 集群实现高可用
2. **PostgreSQL 部署**：部署持久化存储数据库
3. **数据库初始化任务**：创建 `n8n` 数据库
4. **主进程部署**：n8n Web 界面和 API 服务器
5. **Worker 部署**：专用的工作流执行进程

所有部署均包含自动健康检查，完成后即可立即使用。

## 为什么选择在 Sealos 上部署 n8n？

Sealos 是基于 Kubernetes 构建的 AI 云操作系统，从云端 IDE 开发到生产部署和运维，覆盖应用全生命周期。在 Sealos 上部署 n8n，你将获得：

- **一键部署**：秒级部署 n8n 及可选的 PostgreSQL 和 Redis，无需复杂配置，无需 Kubernetes 专业知识
- **灵活架构**：可选择 SQLite 追求简洁、PostgreSQL 确保生产可靠性，或队列模式应对高并发场景
- **数据库开箱即用**：PostgreSQL 和 Redis 自动创建、初始化并配置安全凭据
- **持久存储**：内置持久存储确保工作流、凭据和执行历史在重启和更新后依然保留
- **安全公网访问**：自动分配带 SSL 证书的公网 URL，安全访问 Web 界面和 Webhook 端点
- **时区支持**：可配置实例时区，确保定时工作流准确执行
- **弹性扩展**：通过直观的表单界面，按需调整资源
- **自动安全配置**：加密密钥和数据库凭据均使用密码学安全的随机值自动生成
- **Worker 可扩展**：队列模式支持工作流执行的水平扩展，应对高并发自动化需求

在 Sealos 上部署 n8n，让你专注于构建强大的自动化工作流，而非折腾基础设施。

## 部署指南

1. 访问 [Sealos Cloud](https://os.sealos.io/?openapp=system-brain?trial=true)
2. 点击「从模板创建」
3. 在应用商店搜索「n8n」
4. 配置部署选项：
   - **使用 PostgreSQL**：生产环境建议启用（性能更好、数据持久化）
   - **时区**：选择你的时区，确保定时工作流准确执行
   - **使用队列模式**：需要高并发并行执行时启用（需先启用 PostgreSQL）
5. 点击「部署」
6. 等待部署完成（通常 1-2 分钟）
7. 通过画布中显示的 URL 访问 n8n
8. 首次访问时创建管理员账号

## 配置说明

部署完成后，你可以对 n8n 实例进行个性化配置：

### 初始设置

1. **创建管理员账号**：首次访问时，系统会提示你创建管理员账号（邮箱和密码）
2. **浏览工作流模板**：在模板库中快速找到入门案例
3. **配置凭据**：添加你要集成的服务的凭据
4. **创建首个工作流**：使用可视化编辑器构建你的第一个自动化流程

### 部署模式选择

**各模式适用场景：**

- **基础模式（SQLite）**：
  - ✅ 测试和开发
  - ✅ 个人自动化项目
  - ✅ 低频工作流（每天 < 100 次执行）
  - ❌ 不建议用于多用户生产环境

- **PostgreSQL 模式**：
  - ✅ 生产环境部署
  - ✅ 多用户场景
  - ✅ 中等频率工作流（每天 100-1000 次执行）
  - ✅ 需要可靠数据持久化

- **队列模式**：
  - ✅ 高频自动化（每天 > 1000 次执行）
  - ✅ 需要并行执行的工作流
  - ✅ 需要独立扩展工作流执行能力
  - ✅ 高可靠性要求的生产环境

### 资源调整

在画布中根据需求调整资源：
- **CPU/内存（主进程）**：增加以提升界面性能和并发用户处理能力
- **CPU/内存（Worker）**：增加以加速工作流执行和提高并发处理能力
- **存储**：扩展以保存更多工作流历史和执行数据

### 时区配置

时区设置对定时工作流至关重要：
- 影响所有 Cron 节点和定时触发器
- 部署后可通过更新 Deployment 环境变量修改
- 支持全球主要城市时区

### 服务端点

| 服务 | 端点 | 用途 |
|------|------|------|
| Web 界面 | `https://<app-host>.<domain>` | 工作流编辑器和管理界面 |
| Webhook | `https://<app-host>.<domain>/webhook/<workflow-id>` | 生产 Webhook 端点 |
| 测试 Webhook | `https://<app-host>.<domain>/webhook-test/<workflow-id>` | 测试用 Webhook 端点 |
| PostgreSQL | `<app-name>-pg-postgresql.<namespace>.svc:5432` | 数据库（内部访问，如已启用） |
| Redis | `<app-name>-redis-redis.<namespace>.svc:6379` | 队列（内部访问，如已启用队列模式） |

## 故障排查

### 常见问题

**问题 1：无法创建管理员账号**
- 原因：首次设置未完成
- 解决方案：访问 Web 界面 URL，按照管理员账号创建向导操作。首次部署必须完成此步骤。

**问题 2：定时工作流执行时间不对**
- 原因：时区配置不匹配
- 解决方案：检查部署配置中的时区设置是否与预期一致。如需修改，更新 `GENERIC_TIMEZONE` 和 `TZ` 环境变量。

**问题 3：工作流报数据库错误（PostgreSQL 模式）**
- 原因：数据库未初始化或连接问题
- 解决方案：在画布中确认 PostgreSQL 集群正在运行。检查初始化 Job 的日志确认是否成功完成。数据库连接通过 Kubernetes Secrets 自动配置。

**问题 4：Worker 不处理工作流（队列模式）**
- 原因：Redis 连接问题或 Worker 未运行
- 解决方案：在画布中确认 Redis 和 Worker Deployment 都在运行。查看 Worker 日志排查连接错误。确保已启用 PostgreSQL 模式（队列模式依赖它）。

**问题 5：Webhook 端点无响应**
- 原因：工作流未激活或 Webhook URL 不正确
- 解决方案：确保工作流已激活（工作流编辑器中的开关）。检查 Webhook URL 格式是否正确。排查 Ingress 配置的路由问题。

**问题 6：内存占用过高**
- 原因：大型工作流执行或并发工作流过多
- 解决方案：在画布中增加内存配额。考虑启用队列模式将执行任务分流到专用 Worker。优化工作流效率和数据处理逻辑。

**问题 7：凭据未持久化**
- 原因：存储未正确挂载或加密密钥已变更
- 解决方案：确认持久存储已挂载。切记：初始部署后绝不能修改 `N8N_ENCRYPTION_KEY`，否则所有已存储的凭据都将失效。

### 获取帮助

- [n8n 官方文档](https://docs.n8n.io/)
- [n8n 社区论坛](https://community.n8n.io/)
- [n8n Discord](https://discord.gg/n8n)
- [Sealos Discord 社区](https://discord.gg/wdUn538zVP)

## 更多资源

- [n8n 工作流示例](https://n8n.io/workflows) - 浏览社区创建的工作流模板
- [n8n 节点文档](https://docs.n8n.io/integrations/) - 所有可用节点的完整参考
- [n8n 表达式参考](https://docs.n8n.io/code/expressions/) - 工作流中使用表达式的指南
- [n8n 最佳实践](https://docs.n8n.io/workflows/best-practices/) - 构建高效工作流的技巧
- [PostgreSQL 最佳实践](https://wiki.postgresql.org/wiki/Don%27t_Do_This) - 数据库优化建议
- [Redis 最佳实践](https://redis.io/docs/management/optimization/) - 队列优化指南

## 开发工作流

### 创建工作流

创建你的第一个工作流：

1. **进入编辑器**：访问 n8n URL 并登录
2. **新建工作流**：点击顶部菜单的「Add Workflow」
3. **添加节点**：从左侧面板拖拽节点到画布
4. **配置节点**：点击每个节点进行设置
5. **连接节点**：在节点之间绘制连线定义流程
6. **测试执行**：点击「Execute Workflow」按钮进行测试
7. **激活**：将工作流切换为「Active」状态以启用自动执行

### 使用 Webhook

n8n 提供两种 Webhook 端点：

**生产 Webhook：**
```
https://<app-host>.<domain>/webhook/<workflow-id>
```
- 工作流激活后使用
- URL 固定不变
- 用于生产环境集成

**测试 Webhook：**
```
https://<app-host>.<domain>/webhook-test/<workflow-id>
```
- 工作流开发阶段使用
- 仅在工作流编辑器打开时有效
- 用于激活前的测试

### 管理凭据

1. 进入左侧菜单的 **Credentials**
2. 点击 **Add Credential**
3. 选择服务类型（如 Gmail、Slack、GitHub）
4. 填写所需的认证信息
5. 测试连接
6. 保存凭据
7. 在工作流节点中使用该凭据

**重要提示**：凭据使用 `N8N_ENCRYPTION_KEY` 进行加密。初始部署后切勿修改此密钥，否则所有凭据都将无法访问。

### 工作流最佳实践

1. **错误处理**：始终添加错误处理工作流，优雅地处理失败情况
2. **数据验证**：处理前验证输入数据，防止错误发生
3. **执行限制**：为循环迭代和数据处理设置合理限制
4. **日志记录**：使用「Set」节点记录关键数据点，便于调试
5. **充分测试**：激活前用各种输入场景彻底测试工作流
6. **文档说明**：为复杂工作流添加注释说明逻辑
7. **模块化设计**：将复杂自动化拆分为更小的可复用工作流

### 队列模式优化

使用队列模式时，考虑以下优化策略：

1. **Worker 扩展**：增加 Worker 副本数以提高吞吐量
2. **并发配置**：调整 `N8N_CONCURRENCY` 环境变量（默认：10）
3. **工作流设计**：将工作流设计为无状态，以便更好地并行执行
4. **资源分配**：监控 Worker 资源使用情况，调整 CPU/内存限制
5. **Redis 调优**：对于超高并发场景，考虑增加 Redis 资源

### 监控与维护

**执行历史：**
- 在「Executions」标签页查看所有工作流执行记录
- 按状态筛选（成功、错误、等待中）
- 检查执行数据和错误信息

**性能监控：**
- 在 Sealos 画布中监控资源使用情况
- 在工作流执行历史中查看执行耗时
- 查看队列模式部署的 Worker 日志

**备份与恢复：**
- 工作流定义存储在数据库中
- 生产环境建议定期备份数据库
- 将重要工作流导出为 JSON 进行版本控制

### 升级 n8n

升级到新版本的步骤：

1. 更新 StatefulSet/Deployment 中的镜像标签
2. 通过 Sealos 画布应用更改
3. n8n 启动时会自动运行数据库迁移
4. 升级后验证所有工作流是否正常运行

**注意**：升级前务必查阅 [n8n 发布说明](https://docs.n8n.io/release-notes/)，尤其是大版本更新。

## 安全注意事项

### 凭据管理

- 所有凭据使用 `N8N_ENCRYPTION_KEY` 静态加密存储
- 切勿共享或暴露加密密钥
- 不同部署环境使用独立的凭据
- 定期轮换凭据中使用的 API 密钥和令牌

### Webhook 安全

- 尽可能使用 Webhook 认证（HTTP Basic Auth、Header Auth）
- 验证 Webhook 载荷，防止注入攻击
- 使用 HTTPS（Sealos 自动提供）
- 敏感 Webhook 考虑 IP 白名单

### 访问控制

- 为管理员和用户账号使用强密码
- 根据角色限制用户访问权限（owner、member、viewer）
- 定期审查用户访问权限，移除不活跃账号
- 如你的 n8n 版本支持，启用双因素认证

### 网络安全

- 所有外部通信使用带 SSL 证书的 HTTPS
- 内部服务通信使用 Kubernetes 服务网络
- 数据库和 Redis 不对外暴露
- Webhook 端点是唯一面向公网的入口

## 许可证

本 Sealos 模板采用 MIT 许可证。n8n 采用 [Sustainable Use License](https://github.com/n8n-io/n8n/blob/master/LICENSE.md)——商业使用请参阅许可证详情。
